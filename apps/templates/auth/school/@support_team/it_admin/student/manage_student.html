{% extends 'dashboard/dashboard.html' %}
{% block title %}<title>{{ _('Gestion des élèves: Sailsmakr') }}</title>{% endblock %}
{% block content %}
<div class="container">
    <div class="my-5 d-flex align-items-center justify-content-between">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb p-3 bg-body-tertiary rounded-3 mb-0">
                <li class="breadcrumb-item">
                    <a class="link-body-emphasis" href="{{ url_for('user.user_home', company_id=company.id) }}">
                        <i class="bi bi-house-door-fill"></i>
                        <span class="visually-hidden">{{ _('Accueil') }}</span>
                    </a>
                </li>
                <li class="breadcrumb-item">{{ _('Étudiants') }}</li>
            </ol>
        </nav>
    
        <div class="btn-group" role="group" aria-label="{{ _('Boutons d\'action') }}">
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#createStudentModal">
                <i class="bi bi-plus-circle-dotted"></i>
            </button>
            <button id="btnGroupDrop1" type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-printer"></i>
            </button>
            <ul class="dropdown-menu" aria-labelledby="btnGroupDrop1">
                {% if selected_class and selected_session %}
                    <li>
                        <button class="dropdown-item print-report" type="button" data-class-id="{{ selected_class }}" data-session-id="{{ selected_session }}">
                            <span>
                                <i class="bi bi-file-earmark-pdf"></i>
                            </span>
                            <span>{{ _('Télécharger les rapports en PDF') }}</span>
                        </button>
                    </li>
                    
                    {% if selected_academic_year %}
                        <li>
                            <button class="dropdown-item export-report-excel" type="button" data-class-id="{{ selected_class }}" data-session-id="{{ selected_session }}" data-academic-year-id="{{ selected_academic_year }}">
                                <span>
                                    <i class="bi bi-file-earmark-spreadsheet"></i>
                                </span>
                                <span>{{ _('Exporter les rapports en format Excel') }}</span>
                            </button>
                        </li>
                    {% endif %}
                {% else %}
                    <li class="px-2 text-center text-danger">
                        {{ _('Veuillez sélectionner la session et la classe') }}
                    </li>
                {% endif %}
            </ul>                                   
        </div>
    </div>
    

    <div class="row mb-3">
        
        <div class="col-md-2">
            <label for="session-select">{{ _('Sélectionnez la session') }}</label>
            <select id="session-select" class="form-select" onchange="window.location.href='?session_id=' + this.value + '&class_id={{ selected_class }}'">
                <option value="">{{ _('Tous') }}</option>
                {% for session in sessions %}
                <option value="{{ session.id }}" {% if session.id == selected_session %}selected{% endif %}>{{ session.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="class-select">{{ _('Sélectionnez la classe') }}</label>
            <select id="class-select" class="form-select" onchange="window.location.href='?class_id=' + this.value + '&session_id={{ selected_session }}'">
                <option value="">{{ _('Toutes') }}</option>
                {% for cls in classes %}
                <option value="{{ cls.id }}" {% if cls.id == selected_class %}selected{% endif %}>{{ cls.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="year-select">{{ _('Sélectionnez l\'année') }}</label>
            <select id="year-select" class="form-select" onchange="window.location.href='?academic_year_id=' + this.value + '&session_id={{ selected_session }}&class_id={{ selected_class }}'">
                <option value="">{{ _('Toutes') }}</option>
                {% for year in academic_years %}
                <option value="{{ year.id }}" {% if year.id == selected_academic_year %}selected{% endif %}>{{ year.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-5">
            <label for="student-search">{{ _('Rechercher un élève...') }}</label>
            <input type="text" id="student-search" class="form-control" placeholder="{{ _('Entrez le nom, prénom ou email de l’élève...') }}" oninput="filterStudents()">
        </div>
    </div>

    {% if students %}
        <div class="table-responsive" id="students-list">
            <table class="table align-items-center mb-0 border-bottom">
                <thead>
                    <tr>
                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">{{ _('Prénom') }}</th>
                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">{{ _('Nom de famille') }}</th>
                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">{{ _('Genre') }}</th>
                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">{{ _('Classe') }}</th>
                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">{{ _('Date et Lieu de naissance') }}</th>
                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">{{ _('Actions') }}</th>
                    </tr>
                </thead>
                <tbody id="student-table-body">
                    {% for student in students %}
                    <tr>
                        <td class="first-name">
                            <div class="d-flex align-items-center">
                                <img src="{{ student.user.profile_picture_url or url_for('static', filename='img/feedbacks/no_admins.png') }}" class="avatar avatar-sm me-3" alt="{{ student.user.first_name or '' }} image">
                                <div class="d-flex flex-column justify-content-center">
                                    <h6 class="mb-0 text-sm">{{ student.user.first_name }}</h6>
                                </div>
                            </div>
                        </td>                        
                        <td class="last-name">
                            <div class="d-flex flex-column justify-content-center">
                                <h6 class="mb-0 text-sm">{{ student.user.last_name }}</h6>
                            </div>
                        </td>
                        <td class="align-middle text-center text-sm gender">
                            <span class="text-xs font-weight-bold">{{ student.user.gender }}</span>
                        </td>
                        <td class="align-middle text-center text-sm class">
                            <span class="text-xs font-weight-bold">{{ class_dict[student.class_id] }}</span>
                        </td>
                        <td class="align-middle text-center dob">
                            <span class="text-secondary text-xs font-weight-bold">{{ student.user.date_of_birth.strftime('%d-%m-%Y') }} - {{ student.user.place_of_birth }}</span>
                        </td>
                        <td class="align-middle text-center">
                            <div class="dropdown">
                                <button class="btn btn-sm shadow-lg" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                    ...
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                    <li>
                                        <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#viewStudentModal{{ student.id }}">
                                            {{ _('Voir plus') }}
                                        </button>
                                    </li>
                                    <li>
                                        <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#editStudentModal{{ student.id }}">
                                            <i class="bi bi-pencil"></i> {{ _(' Modifier') }}
                                        </button>
                                    </li>
                                    <li>
                                        <form action="{{ url_for('auth.manage_students', company_id=company.id) }}" method="DELETE" id="DeleteStudentForm">
                                            <button class="dropdown-item text-danger delete-student-button" data-student-id="{{ student.id }}">
                                                <i class="bi bi-trash"></i> Supprimer
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    <!-- View Student Modal -->
                    <div class="modal fade" id="viewStudentModal{{ student.id }}" tabindex="-1" aria-labelledby="viewStudentModalLabel{{ student.id }}" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-left">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="viewStudentModalLabel{{ student.id }}">{{ _('Détails de l\'étudiant') }}</h5>
                                    <button type="button" class="btn-close text-dark" data-bs-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="d-flex justify-content-center my-2">
                                    <img src="{{ student.user.profile_picture_url or url_for('static', filename='img/feedbacks/no_admins.png') }}" class="profile-image rounded-circle" alt="{{ student.user.first_name }}">
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="firstNameView{{ student.id }}" class="form-label">{{ _('Prénom') }}</label>
                                        <input type="text" class="form-control" id="firstNameView{{ student.id }}" value="{{ student.user.first_name }}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label for="lastNameView{{ student.id }}" class="form-label">{{ _('Nom de famille') }}</label>
                                        <input type="text" class="form-control" id="lastNameView{{ student.id }}" value="{{ student.user.last_name }}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label for="genderView{{ student.id }}" class="form-label">{{ _('Genre') }}</label>
                                        <input type="text" class="form-control" id="genderView{{ student.id }}" value="{{ student.user.gender }}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label for="dateOfBirthView{{ student.id }}" class="form-label">{{ _('Date de naissance') }}</label>
                                        <input type="text" class="form-control" id="dateOfBirthView{{ student.id }}" value="{{ student.user.date_of_birth.strftime('%d-%m-%Y') }}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label for="placeOfBirthView{{ student.id }}" class="form-label">{{ _('Lieu de naissance') }}</label>
                                        <input type="text" class="form-control" id="placeOfBirthView{{ student.id }}" value="{{ student.user.place_of_birth }}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label for="emailView{{ student.id }}" class="form-label">{{ _('Email') }}</label>
                                        <input type="email" class="form-control" id="emailView{{ student.id }}" value="{{ student.user.email }}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label for="classView{{ student.id }}" class="form-label">{{ _('Classe') }}</label>
                                        <input type="text" class="form-control" id="classView{{ student.id }}" value="{{ class_dict[student.class_id] }}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label for="sessionView{{ student.id }}" class="form-label">{{ _('Session') }}</label>
                                        <input type="text" class="form-control" id="sessionView{{ student.id }}" value="{{ session_dict[student.session_id] }}" readonly>
                                    </div>
                                    <!-- Uploaded Files Section -->
                                    <div class="file-section container mt-4">
                                        {% set company_files = get_company_files(company_id, student.user.id) %}
                                        {% set has_files = company_files|length > 0 %}
                                        {% if has_files %}
                                            <h3 class="mb-3">{{ _('Fichiers') }}</h3>
                                            <div class="row row-cols-1 row-cols-md-3 g-4">
                                                {% for file in company_files %}
                                                    <div class="col">
                                                        <div class="card h-100 text-center shadow-sm">
                                                            <div class="card-body">
                                                                <a href="{{ file.filepath }}" target="_blank" class="text-decoration-none">
                                                                    {% set ext = file.filepath.split('.')[-1].lower() %}
                                                                    {% if ext in ['pdf'] %}
                                                                        <img src="{{ url_for('static', filename='img/placeholders/pdf.png') }}" class="img-fluid mb-3" alt="{{ file.label }}" style="width: 100px; height: auto;">
                                                                    {% elif ext in ['jpg', 'jpeg', 'png'] %}
                                                                        <img src="{{ url_for('static', filename='img/placeholders/image.png') }}" class="img-fluid mb-3" alt="{{ file.label }}" style="width: 100px; height: auto;">
                                                                    {% elif ext in ['docx'] %}
                                                                        <img src="{{ url_for('static', filename='img/placeholders/doc.png') }}" class="img-fluid mb-3" alt="{{ file.label }}">
                                                                    {% else %}
                                                                        <img src="{{ url_for('static', filename='img/placeholders/file.png') }}" class="img-fluid mb-3" alt="{{ file.label }}">
                                                                    {% endif %}
                                                                    <h5 class="card-title">{{ file.label }}</h5>
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <p class="text-center">{{ _('Aucun fichier disponible.') }}</p>
                                        {% endif %}
                                    </div>                                   
                                </div>
                                <div class="modal-footer d-flex">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Fermer') }}</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Student Modal -->
                    <div class="modal fade" id="editStudentModal{{ student.id }}" tabindex="-1" aria-labelledby="editStudentModalLabel{{ student.id }}" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-left">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editStudentModalLabel{{ student.id }}">{{ _('Modifier les détails de l\'étudiant') }}</h5>
                                    <button type="button" class="btn-close text-dark" data-bs-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="d-flex justify-content-center position-relative my-2">
                                    <div class="position-relative">
                                        {% if student.user.profile_picture_url %}
                                            <img id="profileImage{{ student.id }}" src="{{ student.user.profile_picture_url }}" class="profile-image rounded-circle" alt="{{ student.user.first_name }}">
                                        {% else %}
                                            <div id="placeholder{{ student.id }}" class="profile-placeholder rounded-circle border d-flex justify-content-center align-items-center">
                                                <i class="bi bi-person-fill" style="font-size: 50px;"></i>
                                            </div>
                                        {% endif %}
                                        
                                        <input type="file" id="fileInput{{ student.id }}" class="d-none" accept="image/*" onchange="previewImage(event, '{{ student.id }}')">
                                        
                                        <div class="position-absolute top-50 start-50 translate-middle">
                                            <button class="btn btn-light btn-sm rounded-circle" id="editImageBtn{{ student.id }}" onclick="document.getElementById('fileInput{{ student.id }}').click();">
                                                <i class="bi bi-pencil-fill"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-body">
                                    <form action="{{ url_for('auth.manage_students', company_id=company.id) }}" method="post" enctype="multipart/form-data" class="edit-student-form" data-student-id="{{ student.id }}" data-user-id="{{ student.user.id }}" data-company-id="{{ company.id }}">
                                        <div class="mb-3">
                                            <label for="firstName{{ student.id }}" class="form-label">{{ _('Prénom') }}</label>
                                            <input type="text" class="form-control" id="firstName{{ student.id }}" name="firstName" value="{{ student.user.first_name }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="lastName{{ student.id }}" class="form-label">{{ _('Nom de famille') }}</label>
                                            <input type="text" class="form-control" id="lastName{{ student.id }}" name="lastName" value="{{ student.user.last_name }}" required>
                                        </div>

                                        <!-- Gender Selection -->
                                        <div class="mb-3">
                                            <label for="gender{{ student.id }}" class="form-label">{{ _('Genre') }}</label>
                                            <select class="form-select" id="gender{{ student.id }}" name="gender" required>
                                                <option value="">{{ _('Sélectionner') }}</option>
                                                <option value="M" {% if student.user.gender == 'M' %}selected{% endif %}>{{ _('Masculin') }}</option>
                                                <option value="F" {% if student.user.gender == 'F' %}selected{% endif %}>{{ _('Féminin') }}</option>
                                                <option value="o" {% if student.user.gender == 'O' %}selected{% endif %}>{{ _('Autre') }}</option>
                                            </select>
                                        </div>

                                        <!-- Email -->
                                        <div class="mb-3">
                                            <label for="email{{ student.id }}" class="form-label">{{ _('Email') }}</label>
                                            <input type="email" class="form-control" id="email{{ student.id }}" name="email" value="{{ student.user.email }}" required>
                                        </div>

                                        <!-- Date of Birth -->
                                        <div class="mb-3">
                                            <label for="dob{{ student.id }}" class="form-label">{{ _('Date de naissance') }}</label>
                                            <input type="date" class="form-control" id="dob{{ student.id }}" name="dob" value="{{ student.user.date_of_birth }}" required>
                                        </div>

                                        <!-- Place of Birth -->
                                        <div class="mb-3">
                                            <label for="placeOfBirth{{ student.id }}" class="form-label">{{ _('Lieu de naissance') }}</label>
                                            <input type="text" class="form-control" id="placeOfBirth{{ student.id }}" name="placeOfBirth" value="{{ student.user.place_of_birth }}" required>
                                        </div>

                                        <!-- Class Selection -->
                                        <div class="mb-3">
                                            <label for="classId{{ student.id }}" class="form-label">{{ _('Classe') }}<span class="text-danger">*</span></label>
                                            <select class="form-select" id="classId{{ student.id }}" name="classId" required>
                                                <option value="">{{ _('Sélectionner') }}</option>
                                                {% for cls in classes %}
                                                <option value="{{ cls.id }}" {% if cls.id == student.class_id %}selected{% endif %}>{{ cls.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <!-- Payment Information -->
                                        <div class="mb-3">
                                            <label for="paymentAmount{{ student.id }}" class="form-label">{{ _('Montant versé') }}<span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="paymentAmount{{ student.id }}" name="paymentAmount" placeholder="{{ _('5000') }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="paymentCurrency{{ student.id }}" class="form-label">{{ _('Devise') }}<span class="text-danger">*</span></label>
                                            <select id="paymentCurrency{{ student.id }}" name="paymentCurrency" class="form-select" required>
                                                <option value="" disabled selected>{{ _('Devise') }}</option>
                                                <option value="USD">{{ _('USD') }}</option>
                                                <option value="EUR">{{ _('EUR') }}</option>
                                                <option value="GBP">{{ _('GBP') }}</option>
                                                <option value="JPY">{{ _('JPY') }}</option>
                                                <option value="AUD">{{ _('AUD') }}</option>
                                                <option value="CAD">{{ _('CAD') }}</option>
                                                <option value="CHF">{{ _('CHF') }}</option>
                                                <option value="CNY">{{ _('CNY') }}</option>
                                                <option value="INR">{{ _('INR') }}</option>
                                                <option value="BRL">{{ _('BRL') }}</option>
                                                <option value="RUB">{{ _('RUB') }}</option>
                                                <option value="ZAR">{{ _('ZAR') }}</option>
                                                <option value="MXN">{{ _('MXN') }}</option>
                                                <option value="HKD">{{ _('HKD') }}</option>
                                                <option value="SGD">{{ _('SGD') }}</option>
                                                <option value="NOK">{{ _('NOK') }}</option>
                                                <option value="SEK">{{ _('SEK') }}</option>
                                                <option value="NZD">{{ _('NZD') }}</option>
                                                <option value="KRW">{{ _('KRW') }}</option>
                                                <option value="TRY">{{ _('TRY') }}</option>
                                                <option value="IDR">{{ _('IDR') }}</option>
                                                <option value="THB">{{ _('THB') }}</option>
                                                <option value="MYR">{{ _('MYR') }}</option>
                                                <option value="PLN">{{ _('PLN') }}</option>
                                                <option value="CZK">{{ _('CZK') }}</option>
                                                <option value="HUF">{{ _('HUF') }}</option>
                                                <option value="ILS">{{ _('ILS') }}</option>
                                                <option value="PHP">{{ _('PHP') }}</option>
                                                <option value="AED">{{ _('AED') }}</option>
                                                <option value="SAR">{{ _('SAR') }}</option>
                                                <option value="PKR">{{ _('PKR') }}</option>
                                                <option value="EGP">{{ _('EGP') }}</option>
                                                <option value="NGN">{{ _('NGN') }}</option>
                                                <option value="VND">{{ _('VND') }}</option>
                                                <option value="XOF">{{ _('XOF') }}</option>
                                                <option value="XAF">{{ _('XAF') }}</option>
                                                <option value="KES">{{ _('KES') }}</option>
                                                <option value="GHS">{{ _('GHS') }}</option>
                                                <option value="TZS">{{ _('TZS') }}</option>
                                                <option value="UGX">{{ _('UGX') }}</option>
                                                <option value="MGA">{{ _('MGA') }}</option>
                                                <option value="BWP">{{ _('BWP') }}</option>
                                                <option value="ETB">{{ _('ETB') }}</option>
                                                <option value="DZD">{{ _('DZD') }}</option>
                                                <option value="MAD">{{ _('MAD') }}</option>
                                            </select>
                                        </div>

                                        <div class="upload-files-container">
                                            <div class="drag-file-area" id="dragArea">
                                                <span class="material-icons-outlined upload-icon">cloud_upload</span>
                                                <h3 class="dynamic-message">{{ _('Glissez-déposez un fichier ici.') }}</h3>
                                                <label class="label">
                                                    or 
                                                    <span class="browse-files">
                                                        <input type="file" class="default-file-input" id="fileUpload{{ student.id }}" />
                                                        <span class="browse-files-text">{{ _('parcourir le fichier') }}</span>
                                                        <span>{{ _('depuis l\'appareil') }}</span>
                                                    </span>
                                                </label>
                                            </div>
                                            <span class="cannot-upload-message"> <span class="material-icons-outlined">error</span> {{ _('Veuillez sélectionner un fichier') }} <span class="material-icons-outlined cancel-alert-button">cancel</span> </span>
                                            <div class="file-block" style="display: none;">
                                                <div class="file-info"> 
                                                    <span class="material-icons-outlined file-icon">description</span> 
                                                    <span class="file-name"></span> | 
                                                    <span class="file-size"></span> 
                                                </div>
                                                <span class="material-icons remove-file-icon">delete</span>
                                                <div class="progress-bar"></div>
                                            </div>
                                        </div>

                                        <div class="modal-footer">
                                            <button type="submit" class="btn btn-info" id="submitButton">
                                                <span id="loadingSpinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display:none;"></span>
                                                <span id="loadingText" style="display:none;">{{ _('En cours...') }}</span>
                                                <span id="ButtonText">{{ _('Enregistrer') }}</span>
                                            </button>
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Annuler') }}</button>
                                        </div>
                                        <div class="loading-spinner" style="display: none;">
                                            <div class="spinner-border" role="status">
                                                <span class="sr-only">{{ _('En cours...') }}</span>
                                            </div>
                                            <span>{{ _('En cours...') }}</span>
                                        </div>                                        
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Print Options Modal -->
                    <div class="modal fade" id="printOptionsModal{{ student.id }}" tabindex="-1" aria-labelledby="printOptionsModalLabel{{ student.id }}" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="printOptionsModalLabel{{ student.id }}">{{ _('Options d\'impression de la carte') }}</h5>
                                    <button type="button" class="btn-close text-dark" data-bs-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <!-- Primary Color -->
                                    <div class="mb-3">
                                        <label for="primaryColor{{ student.id }}" class="form-label">{{ _('Couleur primaire') }}</label>
                                        <input type="color" class="form-control form-control-color" id="primaryColor{{ student.id }}" value="#ff77a9">
                                    </div>
                                    <!-- Secondary Color -->
                                    <div class="mb-3">
                                        <label for="secondaryColor{{ student.id }}" class="form-label">{{ _('Couleur secondaire') }}</label>
                                        <input type="color" class="form-control form-control-color" id="secondaryColor{{ student.id }}" value="#203b72">
                                    </div>
                                    <!-- Background Color -->
                                    <div class="mb-3">
                                        <label for="backgroundColor{{ student.id }}" class="form-label">{{ _('Couleur d\'arrière-plan') }}</label>
                                        <input type="color" class="form-control form-control-color" id="backgroundColor{{ student.id }}" value="#ffffff">
                                    </div>
                                    <!-- Text Color -->
                                    <div class="mb-3">
                                        <label for="textColor{{ student.id }}" class="form-label">{{ _('Couleur du texte') }}</label>
                                        <input type="color" class="form-control form-control-color" id="textColor{{ student.id }}" value="#000000">
                                    </div>
                                    <!-- Orientation -->
                                    <div class="mb-3">
                                        <label for="orientation{{ student.id }}" class="form-label">{{ _('Orientation') }}</label>
                                        <select class="form-select" id="orientation{{ student.id }}">
                                            <option value="landscape" selected>{{ _('Paysage') }}</option>
                                            <option value="portrait">{{ _('Portrait') }}</option>
                                        </select>
                                    </div>
                                    <!-- Card Size -->
                                    <div class="mb-3 row">
                                        <div class="col">
                                            <label for="cardWidth{{ student.id }}" class="form-label">{{ _('Largeur (mm)') }}</label>
                                            <input type="number" class="form-control" id="cardWidth{{ student.id }}" value="85">
                                        </div>
                                        <div class="col">
                                            <label for="cardHeight{{ student.id }}" class="form-label">{{ _('Hauteur (mm)') }}</label>
                                            <input type="number" class="form-control" id="cardHeight{{ student.id }}" value="54">
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary">{{ _('Appliquer') }}</button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Annuler') }}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </tbody>
            </table>
            <div id="no-results-message" style="display: none; color: red; font-weight: bold;">
                {{ _('Aucun résultat trouvé pour') }} "<span id="search-query"></span>"
            </div>
            
            
            {% if pagination.pages > 1 %}
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-center">
                        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('auth.manage_students', company_id=company.id, page=pagination.prev_num, session_id=selected_session, class_id=selected_class) }}" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% for page_num in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
                        {% if page_num %}
                            <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('auth.manage_students', company_id=company.id, page=page_num, session_id=selected_session, class_id=selected_class) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                        {% endfor %}
                        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('auth.manage_students', company_id=company.id, page=pagination.next_num, session_id=selected_session, class_id=selected_class) }}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            {% endif %}

        </div>
    {% else %}
        <p class="text-center">{{ _('Aucun élève trouvé pour la session ou la classe sélectionnée.') }}</p>
    {% endif %}
</div>

<!-- Create Student Modal -->
<div class="modal fade" id="createStudentModal" tabindex="-1" aria-labelledby="createStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-left">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createStudentModalLabel">{{ _('Ajouter un nouvel étudiant') }}</h5>
                <button type="button" class="btn-close text-dark" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createStudentForm" action="{{ url_for('auth.manage_students', company_id=company.id) }}" method="post">
                    <div class="mb-3">
                        <label for="firstName" class="form-label">{{ _('Prénom') }} <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="firstName" name="firstName" placeholder="{{ _('Samantha') }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="lastName" class="form-label">{{ _('Nom de famille') }}<span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="lastName" name="lastName" placeholder="{{ _('Larusso') }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="gender" class="form-label">{{ _('Genre') }}<span class="text-danger">*</span></label>
                        <select class="form-select" id="gender" name="gender" required>
                            <option value="">{{ _('Sélectionner') }}</option>
                            <option value="M">{{ _('Masculin') }}</option>
                            <option value="F">{{ _('Féminin') }}</option>
                            <option value="O">{{ _('Autre') }}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="dateOfBirth" class="form-label">{{ _('Date de naissance') }}<span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="dateOfBirth" name="dateOfBirth" required>
                    </div>
                    <div class="mb-3">
                        <label for="placeOfBirth" class="form-label">{{ _('Lieu de naissance') }}<span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="placeOfBirth" name="placeOfBirth" required>
                    </div>
                    <div class="mb-3">
                        <label for="classId" class="form-label">{{ _('Classe') }}<span class="text-danger">*</span></label>
                        <select class="form-select" id="classId" name="classId" required>
                            <option value="">{{ _('Sélectionner') }}</option>
                            {% for cls in classes %}
                            <option value="{{ cls.id }}">{{ cls.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="firstInstallment" class="form-label">{{ _('Montant versé') }}<span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="firstInstallment" name="firstInstallment" placeholder="{{ _('5000') }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="currency" class="form-label">{{ _('Devise') }}<span class="text-danger">*</span></label>
                        <select id="currency" name="currency" class="form-select" required>
                            <option value="" disabled selected>{{ _('Devise') }}</option>
                            <option value="USD">{{ _('USD') }}</option>
                            <option value="EUR">{{ _('EUR') }}</option>
                            <option value="GBP">{{ _('GBP') }}</option>
                            <option value="JPY">{{ _('JPY') }}</option>
                            <option value="AUD">{{ _('AUD') }}</option>
                            <option value="CAD">{{ _('CAD') }}</option>
                            <option value="CHF">{{ _('CHF') }}</option>
                            <option value="CNY">{{ _('CNY') }}</option>
                            <option value="INR">{{ _('INR') }}</option>
                            <option value="BRL">{{ _('BRL') }}</option>
                            <option value="RUB">{{ _('RUB') }}</option>
                            <option value="ZAR">{{ _('ZAR') }}</option>
                            <option value="MXN">{{ _('MXN') }}</option>
                            <option value="HKD">{{ _('HKD') }}</option>
                            <option value="SGD">{{ _('SGD') }}</option>
                            <option value="NOK">{{ _('NOK') }}</option>
                            <option value="SEK">{{ _('SEK') }}</option>
                            <option value="NZD">{{ _('NZD') }}</option>
                            <option value="KRW">{{ _('KRW') }}</option>
                            <option value="TRY">{{ _('TRY') }}</option>
                            <option value="IDR">{{ _('IDR') }}</option>
                            <option value="THB">{{ _('THB') }}</option>
                            <option value="MYR">{{ _('MYR') }}</option>
                            <option value="PLN">{{ _('PLN') }}</option>
                            <option value="CZK">{{ _('CZK') }}</option>
                            <option value="HUF">{{ _('HUF') }}</option>
                            <option value="ILS">{{ _('ILS') }}</option>
                            <option value="PHP">{{ _('PHP') }}</option>
                            <option value="AED">{{ _('AED') }}</option>
                            <option value="SAR">{{ _('SAR') }}</option>
                            <option value="PKR">{{ _('PKR') }}</option>
                            <option value="EGP">{{ _('EGP') }}</option>
                            <option value="NGN">{{ _('NGN') }}</option>
                            <option value="VND">{{ _('VND') }}</option>
                            <option value="XOF">{{ _('XOF') }}</option>
                            <option value="XAF">{{ _('XAF') }}</option>
                            <option value="KES">{{ _('KES') }}</option>
                            <option value="GHS">{{ _('GHS') }}</option>
                            <option value="TZS">{{ _('TZS') }}</option>
                            <option value="UGX">{{ _('UGX') }}</option>
                            <option value="MGA">{{ _('MGA') }}</option>
                            <option value="BWP">{{ _('BWP') }}</option>
                            <option value="ETB">{{ _('ETB') }}</option>
                            <option value="DZD">{{ _('DZD') }}</option>
                            <option value="MAD">{{ _('MAD') }}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="sessionId" class="form-label">{{ _('Session') }}<span class="text-danger">*</span></label>
                        <select class="form-select" id="sessionId" name="sessionId" required>
                            <option value="">{{ _('Sélectionner') }}</option>
                            {% for session in sessions %}
                            <option value="{{ session.id }}">{{ session.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">{{ _('Email de l\'élève') }}<span class="text-danger">*</span> </label>
                        <input type="email" class="form-control" id="email" name="email" placeholder="{{ _('email@exemple.com') }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="parentFirstName" class="form-label">{{ _('Prénom du parent') }}</label>
                        <input type="text" class="form-control" id="parentFirstName" name="parentFirstName">
                    </div>
                    <div class="mb-3">
                        <label for="parentLastName" class="form-label">{{ _('Nom de famille du parent') }}</label>
                        <input type="text" class="form-control" id="parentLastName" name="parentLastName">
                    </div>
                    <div class="mb-3">
                        <label for="parentEmail" class="form-label">{{ _('Email du parent') }}<span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="parentEmail" name="parentEmail">
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-info" id="CreateStudentButton">
                            <span class="spinner-border spinner-border-sm d-none" id="spinner"></span>
                            <span id="ButtonText">
                                <i class="bi bi-plus-circle-dotted"></i>
                                {{ _('Enregistrer') }}
                            </span>
                            <span class="d-none" id="LoadingText">
                                {{ _('En cours...') }}
                            </span>
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Annuler') }}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    function filterStudents() {
        const searchInput = document.getElementById('student-search').value.toLowerCase();
        const tableBody = document.getElementById('student-table-body');
        const rows = tableBody.getElementsByTagName('tr');
        const noResultsMessage = document.getElementById('no-results-message');
        let resultsFound = false;

        if (searchInput === '') {
            for (let row of rows) {
                row.style.display = '';
                resetHighlight(row);
            }
            noResultsMessage.style.display = 'none';
            return;
        }

        for (let i = 0; i < rows.length; i++) {
            const firstName = rows[i].getElementsByClassName('first-name')[0].innerText.toLowerCase();
            const lastName = rows[i].getElementsByClassName('last-name')[0].innerText.toLowerCase();
            const studentClass = rows[i].getElementsByClassName('class')[0].innerText.toLowerCase();
            const profilePicture = rows[i].getElementsByClassName('avatar')[0];

            const firstNameHighlighted = highlightText(firstName, searchInput);
            const lastNameHighlighted = highlightText(lastName, searchInput);
            const classHighlighted = highlightText(studentClass, searchInput);

            if (firstName.includes(searchInput) || lastName.includes(searchInput) || studentClass.includes(searchInput)) {
                rows[i].style.display = '';
                resultsFound = true;
                rows[i].getElementsByClassName('first-name')[0].innerHTML = firstNameHighlighted;
                rows[i].getElementsByClassName('last-name')[0].innerHTML = lastNameHighlighted;
                rows[i].getElementsByClassName('class')[0].innerHTML = classHighlighted;
                profilePicture.style.display = 'block';
            } else {
                rows[i].style.display = 'none';
                profilePicture.style.display = 'none';
            }
        }

        if (noResultsMessage) {
            noResultsMessage.style.display = resultsFound ? 'none' : 'block';
            if (!resultsFound) {
                document.getElementById('search-query').innerText = searchInput;
            }
        }
    }

    function highlightText(text, searchInput) {
        if (!searchInput) return text;
        const regex = new RegExp(`(${searchInput})`, 'gi');
        return text.replace(regex, '<span style="color: pink;">$1</span>');
    }

    function resetHighlight(row) {
        const firstNameCell = row.getElementsByClassName('first-name')[0];
        const lastNameCell = row.getElementsByClassName('last-name')[0];
        const classCell = row.getElementsByClassName('class')[0];

        if (firstNameCell) {
            firstNameCell.innerHTML = firstNameCell.innerText;
        }
        if (lastNameCell) {
            lastNameCell.innerHTML = lastNameCell.innerText;
        }
        if (classCell) {
            classCell.innerHTML = classCell.innerText;
        }
    }
</script>

<script>
    function previewImage(event, studentId) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('profileImage' + studentId);
                if (img) {
                    img.src = e.target.result;
                } else {
                    const placeholder = document.getElementById('placeholder' + studentId);
                    placeholder.innerHTML = '<img src="' + e.target.result + '" class="profile-image rounded-circle" alt="Profile Picture">';
                }
            };
            reader.readAsDataURL(file);
        }
    }
</script>
<script type="module" src="{{ url_for('static', filename='js/async/api/@support_team/Reports/SessionReport.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/async/api/@support_team/Reports/SessionReportExcel.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/async/api/@support_team/Student/CreateStudent.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/async/api/@support_team/Student/UpdateStudent.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/async/api/@support_team/Student/DeleteStudent.js') }}"></script>

{% endblock %}
